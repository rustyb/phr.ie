<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        .mapboxgl-popup-content { min-width:180px; padding:0; max-width: 220px;}
    </style>
</head>
<body>

<style>
.boxdraw {
    background: rgba(56,135,190,0.1);
    border: 2px solid #3887be;
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 0;
}
.sidebar-panel {
    width: 320px;
}

.big-num {
    font-size: 2em;
    font-weight: 900;
}
</style>

<div id='map'></div>

<div class='pin-topleft pad1 sidebar-panel z10 sidebar-container'>
  <div class='fill-white round lifted'>
    <div class='pad2'>
      <h3 class='block space-bottom1'>The ageing population of Ireland</h3>
      <div class='prose quiet'>
        <p>Hold <strong><kbd>Shift</kbd>  & drag your mouse</strong> accross the map to query the population of the Small Areas.</p>
      </div>
    </div>
    <div id='aggregates' class='fill-navy-dark round-bottom pad2 small dark'></div>
  </div>
</div>

<script>

var aggregateContainer = document.getElementById('aggregates');

mapboxgl.accessToken = 'pk.eyJ1IjoicnVzdHkiLCJhIjoib0FjUkJybyJ9.V9QoXck_1Z18MhpwyIE2Og';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v8',
    center: [-7.478,53.027],
    hash: true,
    minZoom: 6,
    zoom: 7
});

// Disable default box zooming.
map.boxZoom.disable();

// Create a popup, but don't add it to the map yet.
var popup = new mapboxgl.Popup({
    closeButton: false
});

map.on('load', function() {
    var canvas = map.getCanvasContainer();

    // Variable to hold the starting xy coordinates
    // when `mousedown` occured.
    var start;

    // Variable to hold the current xy coordinates
    // when `mousemove` or `mouseup` occurs.
    var current;

    // Variable for the draw box element.
    var box;
    
    map.addControl(new mapboxgl.Navigation({position: 'top-right'}));

    // Add the source to query. In this example we're using
    // county polygons uploaded as vector tiles
    map.addSource('counties', {
        "type": "vector",
        "url": "mapbox://rusty.0o0aodf6"
    });

    map.addLayer({
        "id": "counties",
        "type": "fill",
        "source": "counties",
        "source-layer": "census2011_sap_65plusgeojson",
        "paint": {
            "fill-outline-color": "rgba(0,0,0,0.1)",
            "fill-color": "rgba(0,0,0,0.1)"
        }
    }, 'place-city-sm'); // Place polygon under these labels.

    map.addLayer({
        "id": "counties-highlighted",
        "type": "fill",
        "source": "counties",
        "source-layer": "census2011_sap_65plusgeojson",
        "paint": {
            "fill-outline-color": "#484896",
            "fill-color": "#6e599f",
            "fill-opacity": 0.75
        },
        "filter": ["in", "SMALL_AREA", ""]
    }, 'place-city-sm'); // Place polygon under these labels.

    // Add layers for showing the nursing homes
    map.addSource('nursingHomes', {
        "type": "vector",
        "url": "mapbox://rusty.23z2k80t"
    });

    map.addLayer({
        "layout": {
            "visibility": "visible"
        },
        "type": "circle",
        "source": "nursingHomes",
        "id": "nursing-homes-style",
        "paint": {
            "circle-color": {
                property: "public_private",
                stops:[
                    ["Private", "#27b691"],
                    ["","#ED5299"]
                ]
            },
            "circle-opacity": 0.8,
            "circle-radius": {
                property: 'beds',
                stops: [
                    [{zoom: 8,  value: 10}, 2],
                    [{zoom: 8,  value: 50}, 3],
                    [{zoom: 8,  value: 100}, 6],
                    [{zoom: 8,  value: 150}, 8],

                    [{zoom: 10,  value: 10}, 3],
                    [{zoom: 10,  value: 50}, 5],
                    [{zoom: 10,  value: 100}, 10],
                    [{zoom: 10,  value: 150}, 15]
                    ]
                }
            },
        "source-layer": "nursing_home_capacity_",
        "interactive": true
        })

    // Set `true` to dispatch the event before other functions
    // call it. This is necessary for disabling the default map
    // dragging behaviour.
    canvas.addEventListener('mousedown', mouseDown, true);

    // Return the xy coordinates of the mouse position
    function mousePos(e) {
        var rect = canvas.getBoundingClientRect();
        return new mapboxgl.Point(
            e.clientX - rect.left - canvas.clientLeft,
            e.clientY - rect.top - canvas.clientTop
        );
    }

    function mouseDown(e) {
        // Continue the rest of the function if the shiftkey is pressed.
        if (!(e.shiftKey && e.button === 0)) return;

        // Disable default drag zooming when the shift key is held down.
        map.dragPan.disable();

        // Call functions for the following events
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        document.addEventListener('keydown', onKeyDown);

        // Capture the first xy coordinates
        start = mousePos(e);
    }

    function onMouseMove(e) {
        // Capture the ongoing xy coordinates
        current = mousePos(e);

        // Append the box element if it doesnt exist
        if (!box) {
            box = document.createElement('div');
            box.classList.add('boxdraw');
            canvas.appendChild(box);
        }

        var minX = Math.min(start.x, current.x),
            maxX = Math.max(start.x, current.x),
            minY = Math.min(start.y, current.y),
            maxY = Math.max(start.y, current.y);

        // Adjust width and xy position of the box element ongoing
        var pos = 'translate(' + minX + 'px,' + minY + 'px)';
        box.style.transform = pos;
        box.style.WebkitTransform = pos;
        box.style.width = maxX - minX + 'px';
        box.style.height = maxY - minY + 'px';
    }

    function onMouseUp(e) {
        // Capture xy coordinates
        finish([start, mousePos(e)]);
    }

    function onKeyDown(e) {
        // If the ESC key is pressed
        if (e.keyCode === 27) finish();
    }

    function finish(bbox) {
        // Remove these events now that finish has been called.
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('keydown', onKeyDown);
        document.removeEventListener('mouseup', onMouseUp);

        if (box) {
            box.parentNode.removeChild(box);
            box = null;
        }

        // If bbox exists. use this value as the argument for `queryRenderedFeatures`
        if (bbox) {
            var features = map.queryRenderedFeatures(bbox, { layers: ['counties'] });

            if (features.length >= 1000) {
                return window.alert('Select a smaller number of features');
            }

            // Run through the selected features and set a filter
            // to match features with unique FIPS codes to activate
            // the `counties-highlighted` layer.
            // get the sum of population
            var totalPop = 0;
            var total65 = 0;
            var total85 = 0;
            
            var filter = features.reduce(function(memo, feature) {
                memo.push(feature.properties['SMALL_AREA']);
                totalPop += feature.properties['TOTAL2011'];
                total65 += feature.properties['AGE65_69T'] + feature.properties['AGE70_74T'] + feature.properties['AGE75_79T'] + feature.properties['AGE80_84T'] 
                total85 += feature.properties['T1_1AGEGE_85T'];
                return memo;
            }, ['in', 'SMALL_AREA']);
            console.log(filter);
            console.log(totalPop, 'is the total population');
            console.log(total65, '65 - 84 AGE is the total population');
            console.log(total85, '85+ is the total population');

            aggregateContainer.innerHTML = '';
            var count = document.createElement('strong');
            count.className = 'block space-bottom1';
            count.textContent = features.length.toLocaleString() + ' small areas selected';
            aggregateContainer.appendChild(count);

            
            var aggregates = [{
                label: 'total population',
                number: totalPop
            }, {
                label: 'aged 65-84',
                number: total65,
                pc: Math.round((total65 / totalPop) * 100).toFixed(2)
            }, {
                label: 'aged 85+',
                number: total85,
                pc: Math.round((total85 / totalPop) * 100).toFixed(2)
            }]

            aggregates.forEach(function(d) {
                var numBig = document.createElement('div');
                numBig.className = 'clearfix col12 space-bottom1 dark contain big-num';
                if (d.pc) {
                    numBig.textContent = d.number.toLocaleString() + ' / ' + d.pc.toLocaleString() + '%' ;
                } else {
                    numBig.textContent = d.number.toLocaleString()
                }

                aggregateContainer.appendChild(numBig);

                var label = document.createElement('strong');
                label.className = 'block space-bottom0 quiet small strong';
                label.textContent = d.label
                
                aggregateContainer.appendChild(label);
            });
            

            map.setFilter("counties-highlighted", filter);
        }

        map.dragPan.enable();
    }

    map.on('mousemove', function(e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['counties-highlighted'] });
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

        if (!features.length) {
            popup.remove();
            return;
        }

        var feature = features[0];

        popup.setLngLat(e.lngLat)
            .setText(feature.properties.EDNAME)
            .addTo(map);
    });

    // When a click event occurs near a marker icon, open a popup at the location of
    // the feature, with description HTML from its properties.
    map.on('click', function (e) {
        var popup = new mapboxgl.Popup();
        var features = map.queryRenderedFeatures(e.point, { layers: ["nursing-homes-style"] })

        if (!features.length) {

            return;
        }

        var feature = features[0];

        var topColor = feature.properties.public_private == "Private" ? '#27b691' : '#ED5299';
        var popUpHTML = '<div class="pad1 round-top dark" style="background-color:'+topColor+'">' +
                            '<h3>' + feature.properties.name + '</h3></div>' +
                            '<div class="pad1 fill-white round-bottom">' + 
                                '<h4 class="capitalize">'+ feature.properties.beds + ' beds</h4>' +
                                '<span class="quiet">' + feature.properties.county + '</span>' +
                            '</div>';
        // Populate the popup and set its coordinates
        // based on the feature found.
        popup.setLngLat(map.unproject(e.point))
            .setHTML(popUpHTML)
            .addTo(map);
    });
});
</script>

</body>
</html>
